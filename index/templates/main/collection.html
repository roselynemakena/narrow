<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="jQuery formBuilder: A jQuery plugin for drag and drop form creation">
  <link rel="stylesheet" type="text/css" media="screen" href="../../static/assets/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" media="screen" href="../../static/assets/demo.css">
  <!-- Only include on form edit page -->
  <link rel="stylesheet" type="text/css" media="screen" href="../../static/assets/form-builder.css">
  <!-- Only include on form render page -->
  <link rel="stylesheet" type="text/css" media="screen" href="../../static/assets/form-render.css">
  </head>

<body>
 
    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
   
        <div class="build-form">
          <a href="{{url_for('index.services')}}">go back to services </a>
          <h2><strong>Build You Task </strong></h2>
          <a href="{{url_for('index.services')}}">pick a crowd  </a>
         
          
        </div>
        <button id="render-form-button" class="btn btn-primary">Create Task</button>
          <div class="render-form">
          <h2><strong>Render The Form</strong></h2>
          <form id="rendered-form">
            <form action="this is the action">
            <input type="text" name="task_name" placeholder="task name"/>
            <textarea >description of the task</textarea>
            <textarea name="form-builder-template" id="form-builder-template" cols="30" rows="10"></textarea>
          </form>
          </form>
          
        </div>
         
    <!-- FOOTER  -->
  
  </div>
  
  <script src="../../static/assets/jquery.min.js"></script>
  <script src="../../static/assets/jquery-ui.min.js"></script>
  <!-- Only include on form edit page -->
  <script src="../../static/assets/form-builder.min.js"></script>
  <!-- Only include on form render page -->
  <script src="../../static/assets/form-render.min.js"></script>
  <script>
  jQuery(document).ready(function($) {
    'use strict';
    var template = document.getElementById('form-builder-template'),
      formContainer = document.getElementById('rendered-form'),
      renderBtn = document.getElementById('render-form-button');
    $(template).formBuilder();

    $(renderBtn).click(function(e) {
      e.preventDefault();
      $(template).formRender({
        container: $(formContainer)
      });
      var data = new FormData();
      var json = mapDOM(formContainer, true);
data.append("task_data", json);

var xhr = new XMLHttpRequest();
xhr.withCredentials = true;

xhr.addEventListener("readystatechange", function () {
  if (this.readyState === 4) {
    console.log(this.responseText);
  }
});

xhr.open("POST", "{{url_for('index.task_data',_external=True)}}");
xhr.setRequestHeader("cache-control", "no-cache");

xhr.send(data);
    console.log(formContainer);
    window.location = "{{url_for('index.crowd_selection')}}"
    });

  });
  function mapDOM(element, json) {
    var treeObject = {};

    // If string convert to document Node
    if (typeof element === "string") {
        if (window.DOMParser) {
              parser = new DOMParser();
              docNode = parser.parseFromString(element,"text/xml");
        } else { // Microsoft strikes again
              docNode = new ActiveXObject("Microsoft.XMLDOM");
              docNode.async = false;
              docNode.loadXML(element);
        }
        element = docNode.firstChild;
    }

    //Recursively loop through DOM elements and assign properties to object
    function treeHTML(element, object) {
        object["type"] = element.nodeName;
        var nodeList = element.childNodes;
        if (nodeList != null) {
            if (nodeList.length) {
                object["content"] = [];
                for (var i = 0; i < nodeList.length; i++) {
                    if (nodeList[i].nodeType == 3) {
                        object["content"].push(nodeList[i].nodeValue);
                    } else {
                        object["content"].push({});
                        treeHTML(nodeList[i], object["content"][object["content"].length -1]);
                    }
                }
            }
        }
        if (element.attributes != null) {
            if (element.attributes.length) {
                object["attributes"] = {};
                for (var i = 0; i < element.attributes.length; i++) {
                    object["attributes"][element.attributes[i].nodeName] = element.attributes[i].nodeValue;
                }
            }
        }
    }
    treeHTML(element, treeObject);

    return (json) ? JSON.stringify(treeObject) : treeObject;
}

  </script>

</body>

</html>
